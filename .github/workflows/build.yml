name: iOS TestFlight Deployment

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'testflight'
        type: choice
        options:
        - testflight
        - development
      force_write:
        description: 'Force certificate creation (first time setup)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  RUBY_VERSION: '3.2'

jobs:
  build-and-deploy:
    runs-on: macos-15
    timeout-minutes: 45
    
    steps:
    - name: 📱 Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 🏷️ Generate build number
      id: build_number
      run: |
        BUILD_NUMBER=$(date +%Y%m%d%H%M)
        echo "build_number=${BUILD_NUMBER}" >> $GITHUB_OUTPUT
        echo "Build number: ${BUILD_NUMBER}"

    - name: 📦 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: 📦 Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest
        
    - name: 📥 Install dependencies
      run: |
        pnpm install --frozen-lockfile
        echo "✅ Dependencies installed"

    - name: 🔍 Run code quality checks
      run: |
        echo "Running comprehensive Biome CI checks (linting, formatting, imports)..."
        echo "⚠️  This will FAIL LOUDLY if any code quality issues are found!"
        pnpm exec biome ci src/
        echo "✅ All code quality checks passed - no linting, formatting, or import issues found!"
        
    - name: 🏗️ Build Capacitor app
      run: |
        echo "Building React app..."
        pnpm build
        echo "✅ React build complete"
        
    - name: 💎 Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        bundler-cache: true
        working-directory: ios
        
    - name: 📱 Select Xcode 16.4
      run: |
        sudo xcode-select -s /Applications/Xcode_16.4.app
        xcodebuild -version
        echo "✅ Xcode 16.4 selected for latest iOS SDK support"
        
    - name: 🔧 Fix iTMSTransporter OSStatus -10814 issue  
      run: |
        echo "🔍 Fixing iTMSTransporter OSStatus -10814 error..."
        
        # Clear iTMSTransporter cache completely to force version 2.3.0 (fixes v3.0.0 issues)
        echo "🧹 Clearing iTMSTransporter cache to revert to stable version 2.3.0..."
        rm -rf ~/Library/Caches/com.apple.amp.itmstransporter 2>/dev/null || true
        rm -rf /tmp/itmstransporter* 2>/dev/null || true
        
        # Check current iTMSTransporter version after cache clear
        if xcrun --find iTMSTransporter >/dev/null 2>&1; then
          TRANSPORTER_PATH=$(xcrun --find iTMSTransporter)
          echo "✅ Found iTMSTransporter via xcrun: $TRANSPORTER_PATH"
          
          # Try to get version info (may not work but helpful for debugging)
          "$TRANSPORTER_PATH" -version 2>/dev/null || echo "Could not get version info"
        fi
        
        # Configure Fastlane environment variables for optimal compatibility
        # Use shell script mode to avoid Java dependency issues with iTMSTransporter 3.0.0
        echo "FASTLANE_ITUNES_TRANSPORTER_USE_SHELL_SCRIPT=1" >> $GITHUB_ENV
        
        # Force package upload for reliability - let iTMSTransporter auto-discover transport
        echo "ITMSTRANSPORTER_FORCE_ITMS_PACKAGE_UPLOAD=true" >> $GITHUB_ENV
        
        # Additional environment variables to ensure API key authentication works
        echo "FASTLANE_SKIP_2FA_UPGRADE=1" >> $GITHUB_ENV
        
        echo "✅ iTMSTransporter OSStatus -10814 fix complete"
        
    - name: 📱 Sync Capacitor iOS
      run: |
        echo "Syncing Capacitor iOS..."
        pnpm cap:sync:ios
        echo "✅ Capacitor iOS sync complete"
        
    - name: 🔧 Install CocoaPods dependencies
      run: |
        cd ios/App
        pod install --repo-update
        echo "✅ CocoaPods dependencies installed"
        
    - name: 🔐 Setup SSH Deploy Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.FASTLANE_MATCH_DEPLOY_KEY }}" > ~/.ssh/match_deploy_key
        chmod 600 ~/.ssh/match_deploy_key
        ssh-keyscan github.com >> ~/.ssh/known_hosts
        # Configure SSH to use the deploy key for GitHub
        cat > ~/.ssh/config << EOF
        Host github.com
          HostName github.com
          User git
          IdentityFile ~/.ssh/match_deploy_key
          IdentitiesOnly yes
        EOF
        chmod 600 ~/.ssh/config
        echo "✅ SSH Deploy Key configured"
        
    - name: 🔐 Setup Keychain
      run: |
        security create-keychain -p "" build.keychain
        security list-keychains -s build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security set-keychain-settings -t 3600 -u build.keychain
        echo "✅ Keychain configured"
        
    - name: 📜 Generate certificates and profiles
      run: |
        cd ios
        bundle exec fastlane certificates_distribution
        echo "✅ Certificates and provisioning profiles ready"
      env:
        ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
        ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
        ASC_PRIVATE_KEY: ${{ secrets.ASC_PRIVATE_KEY }}
        MATCH_PASSWORD: ${{ secrets.FASTLANE_MATCH_PASSWORD }}
        GIT_SSH_COMMAND: "ssh -i ~/.ssh/match_deploy_key -o IdentitiesOnly=yes"
        MATCH_GIT_URL: ${{ secrets.FASTLANE_MATCH_GIT_URL }}
        MATCH_FORCE_WRITE: ${{ github.event.inputs.force_write || 'false' }}
        
    - name: 🚀 Build and upload to TestFlight
      run: |
        cd ios
        bundle exec fastlane beta
      env:
        ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
        ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
        ASC_PRIVATE_KEY: ${{ secrets.ASC_PRIVATE_KEY }}
        MATCH_PASSWORD: ${{ secrets.FASTLANE_MATCH_PASSWORD }}
        GIT_SSH_COMMAND: "ssh -i ~/.ssh/match_deploy_key -o IdentitiesOnly=yes"
        MATCH_GIT_URL: ${{ secrets.FASTLANE_MATCH_GIT_URL }}
        MATCH_FORCE_WRITE: ${{ github.event.inputs.force_write || 'false' }}
        
    - name: 📤 Upload build artifacts
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-logs
        path: |
          ios/App/build/**/*.log
          ~/Library/Logs/gym/**
        retention-days: 5
        
    - name: 💬 Create deployment summary
      if: success()
      run: |
        echo "## 🎉 iOS Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Number**: ${{ steps.build_number.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow**: [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. 🔍 Check [App Store Connect](https://appstoreconnect.apple.com) for your build" >> $GITHUB_STEP_SUMMARY
        echo "2. 📱 Build will be available in TestFlight within 10-15 minutes" >> $GITHUB_STEP_SUMMARY
        echo "3. 👥 Add testers and distribute when ready" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "_Build completed at $(date)_" >> $GITHUB_STEP_SUMMARY

    - name: 🧹 Cleanup Keychain
      if: always()
      run: |
        security delete-keychain build.keychain || true
        echo "✅ Keychain cleanup complete"